# This file is part of shinyStan
# Copyright (C) 2015 Jonah Sol Gabry & Stan Development Team
#
# shinyStan is free software; you can redistribute it and/or modify it under the
# terms of the GNU General Public License as published by the Free Software
# Foundation; either version 3 of the License, or (at your option) any later
# version.
# 
# shinyStan is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
# A PARTICULAR PURPOSE.  See the GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License along with
# this program; if not, see <http://www.gnu.org/licenses/>.



# options(shiny.trace=TRUE)
source("helper_functions/shinyStan_helpers.R", local=TRUE)
source("server_files/pp_check/plot_names_descriptions.R", local = TRUE)
source("server_files/utilities/extract_shinystan_object.R", local=TRUE)

# Begin shinyServer -------------------------------------------------------
# _________________________________________________________________________
function(input, output, session) {
  
  # Stop the app when "Quit" button is clicked
  observe({
    if (input$nav == "quit") stopApp("Session ended")
  })
  
  # source all files from server_files directory and subdirectories
  files <- list.files("server_files", full.names = TRUE, recursive = TRUE)
  for (f in files) source(f, local = TRUE)

  # tooltips
  for (id in seq_along(tooltip_ids)) {
    addTooltip(session, id = tooltip_ids[id], trigger = "hover", placement = tooltip_placements[id],
               title = tooltip_msgs[id], options = list(container = 'body'))
  }
  
  #### DATATABLE: summary stats (all parameters) ####
  output$all_summary_out <- DT::renderDataTable({
  DT::datatable({
    summary_stats()
  },
  filter = 'bottom',
  options = list(
    searchHighlight = TRUE,
    search = list(regex = input$user_regex), # allow regular expression when searching for parameter names
    processing = TRUE,
    pagingType = "full", # show only first, previous, next, last buttons (no page numbers)
    pageLength = 10,
    lengthMenu = list(c(5, 10, 20, 50, -1), c('5', '10', '20', '50', 'All')),
    scrollY = 400,
    scrollX = TRUE,
    autoWidth = TRUE,
    scrollCollapse = FALSE,
    columnDefs = list(list(width="85px", targets=list(0)), list(sClass="alignRight", targets ="_all")),
    initComplete = htmlwidgets::JS( # change text color of column titles
            'function(settings, json) {
          $(this.api().table().header()).css({"color": "#337ab7"});
          }'),
    rowCallback = htmlwidgets::JS(
            'function(row, data) {
            // Bold cells in the first column
              $("td:eq(0)", row).css("font-weight", "bold");
          }')
  )
  )
  })
  # download the table
  output$download_all_summary <- downloadHandler(
    filename = paste0('shinystan_summary_stats.RData'),
    content = function(file) {
      shinystan_summary_stats <- summary_stats()
      save(shinystan_summary_stats, file = file)
    }
  )
  # latex the table
  observeEvent(input$tex_go, handlerExpr = {
    summary_stats_latex()
  })
  #### DATATABLE: summary stats (sampler) ####
  output$sampler_summary <- DT::renderDataTable({
  DT::datatable({
    summary_stats_sampler()
  }, options = list(
    rownames = FALSE,
    processing = TRUE,
    scrollX = TRUE,
    scrollY = "200px",
    # autoWidth = TRUE,
    scrollCollapse = TRUE,
    paging = FALSE,
    # pageLength = 3,
    searching = FALSE,
    info = FALSE,
    aoColumnDefs = list(list(sClass="alignRight", aTargets = "_all")),
    orderClasses = TRUE,
    initComplete = htmlwidgets::JS( # change text color of column titles
      'function(settings, json) {
      $(this.api().table().header()).css({"color": "#337ab7"});
      }'),
    rowCallback = htmlwidgets::JS(
      'function(row, data) {
        // Bold cells in the first column
          $("td:eq(0)", row).css("font-weight", "bold");
      }')
  )
  )
  })
  #### PLOT: sampler params ####
  output$sampler_plot_treedepth_out <- renderPlot({
    sampler_plot_treedepth()
  }, bg = "transparent")
  output$sampler_plot_treedepth0_out <- renderPlot({
    sampler_plot_treedepth0()
  }, bg = "transparent")
  output$sampler_plot_treedepth1_out <- renderPlot({
    sampler_plot_treedepth1()
  }, bg = "transparent")
  output$sampler_plot_divergent_out <- renderPlot({
    x <- sampler_plot_divergent()
    suppress_and_print(x)
  }, bg = "transparent")
  
  #### PLOT: multiple parameters ####
  output$plot_param_vertical_out <- renderPlot({
    plot_param_vertical()
  }, height = calc_height_param_plot, bg = "transparent")
  # download the plot
  output$download_multiparam_plot <- downloadHandler(
    filename = 'shinystan_param_plot.RData',
    content = function(file) {
      shinystan_param_plot <- plot_param_vertical()
      save(shinystan_param_plot, file = file)
    }
  )
  #### PLOT: n_eff / total sample size ####
  output$n_eff_plot_out <- renderPlot({
    x <- n_eff_plot()
    suppress_and_print(x)
  }, bg = "transparent")
  #### PLOT: ratio of mcmc se to posterior sd  ####
  output$mcse_over_sd_plot_out <- renderPlot({
    x <- mcse_over_sd_plot()
    suppress_and_print(x)
  }, bg = "transparent")
  #### PLOT: rhat ####
  output$rhat_plot_out <- renderPlot({
    x <- rhat_plot()
    suppress_and_print(x)
  }, bg = "transparent")
  #### TEXT: n_eff warnings ####
  output$n_eff_warnings_title <- renderText({
    paste0("The following parameters have an effective sample size less than ", input$n_eff_threshold,"% of the total number of samples: ")
  })
  output$n_eff_warnings <- renderText({
    n_eff_warnings()
  })
  #### TEXT: rhat warnings ####
  output$rhat_warnings_title <- renderText({
    paste0("The following parameters have an Rhat value above ", input$rhat_threshold,": ")
  })
  output$rhat_warnings <- renderText({
    rhat_warnings()
  })
  #### TEXT: mcmc se to posterior sd warnings ####
  output$mcse_over_sd_warnings_title <- renderText({
    paste0("The following parameters have a Monte Carlo standard error greater than ", input$mcse_threshold ,"% of the posterior standard deviation:")
  })
  output$mcse_over_sd_warnings <- renderText({
    mcse_over_sd_warnings()
  })
  #### PLOT: autocorrelation ####
  output$autocorr_plot_out <- renderPlot({
    autocorr_plot()
  }, bg = "transparent")
  # download the plot
  output$download_autocorr <- downloadHandler(
    filename = paste0('shinystan_autocorr.RData'),
    content = function(file) {
      shinystan_autocorr <- autocorr_plot
      save(shinystan_autocorr, file = file)
    }
  )
  #### PLOT: trace plots (multiple parameters) ####
  output$multi_trace_plot_out <- renderPlot({
    x <- multi_trace_plot()
    suppressWarnings(print(x)) # this avoids warnings about removing rows when using tracezoom feature
  }, height = calc_height_trace_plot, bg = "transparent")
  # download the plot
  output$download_multi_trace <- downloadHandler(
    filename = paste0('shinystan_multi_trace.RData'),
    content = function(file) {
      shinystan_multi_trace <- multi_trace_plot()
      save(shinystan_multi_trace, file = file)
    }
  )
  #### TEXT: parameter name ####
  output$param_name <- renderText({
    input$param
  })
  #### TABLE: summary stats (single parameter) ####
  output$parameter_summary_out <- DT::renderDataTable({
    DT::datatable({
    as.data.frame(round(parameter_summary(), 2))
  }, 
  rownames = FALSE,
  options = list(
    paging = FALSE, searching = FALSE, info = FALSE, ordering = FALSE,
    autoWidth = TRUE,
    columnDefs = list(list(sClass="alignRight", targets ="_all")),
    initComplete = htmlwidgets::JS( # change background color of table header
      'function(settings, json) {
      $(this.api().table().header()).css({"background-color": "transparent", "color": "black"});
      }')
  ))
  })
  #### PLOT: Multiview ####
  output$multiview_param_name <- renderUI(strong(style = "font-size: 250%; color: #f9dd67;", input$param))
  output$multiview_trace <- renderPlot(trace_plot_multiview(), bg = "transparent")
  output$multiview_density <- renderPlot(density_plot_multiview(), bg = "transparent")
  output$multiview_autocorr <- renderPlot(autocorr_plot_multiview(), bg = "transparent")
  # download multiview plot
  output$download_multiview <- downloadHandler(
    filename = 'shinystan_multiview.RData',
    content = function(file) {
      param_name <- input$param
      shinystan_multiview <- list()
      shinystan_multiview[[paste0("trace_", param_name)]] <- trace_plot_multiview()
      shinystan_multiview[[paste0("density", param_name)]] <- density_plot_multiview()
      shinystan_multiview[[paste0("ac_", param_name)]] <- autocorr_plot_multiview()
      save(shinystan_multiview, file = file)
    }
  )
  ### PLOT: histogram ####
  output$hist_plot_out <- renderPlot({
    x <- hist_plot()
    suppress_and_print(x)
  }, bg = "transparent")
  # download plot
  output$download_histogram <- downloadHandler(
    filename = 'shinystan_histogram.RData',
    content = function(file) {
      shinystan_histogram <- hist_plot()
      save(shinystan_histogram, file = file)
    }
  )
  #### PLOT: dynamic trace plot ####
  output$dynamic_trace_plot_out <- dygraphs::renderDygraph({
    dynamic_trace_plot()
  })
  ### PLOT: density ####
  output$density_plot_out <- renderPlot({
    density_plot()
  }, bg = "transparent")
  # download plot
  output$download_density <- downloadHandler(
    filename = 'shinystan_density.RData',
    content = function(file) {
      shinystan_density <- density_plot()
      save(shinystan_density, file = file)
    }
  )
  #### PLOT: trivariate 3D ####
  output$trivariate_plot_out <- threejs::renderScatterplotThree({
    trivariate_plot()
  })
  #### PLOT: bivariate ####
  output$bivariate_plot_out <- renderPlot({
    x <- bivariate_plot()
    suppressWarnings(print(x))
  }, bg = "transparent")
  output$download_bivariate <- downloadHandler(
    filename = 'shinystan_bivariate.RData',
    content = function(file) {
      shinystan_bivariate <- bivariate_plot()
      save(shinystan_bivariate, file = file)
    }
  )
  #### TEXT: User's model notes ####
  observeEvent(input$save_user_model_info, handlerExpr = {
    if (input$user_model_info != "")
      shinystan_object@user_model_info <<- input$user_model_info
  })
  output$user_text_saved <- renderText({
    input$save_user_model_info # take dependency on action button
    if (input$save_user_model_info != 0) {
      print(paste("Saved:  ", format(Sys.time(), "%a %b %d %Y %X")))
    }
  })
  #### PLOT: pp hists_rep_vs_obs####
  output$pp_hists_rep_vs_obs_out <- renderPlot({
    x <- suppressMessages(suppressWarnings(pp_hists_rep_vs_obs()))
    suppress_and_print(x)
  }, bg = "transparent")
  #### PLOT: pp dens_rep_vs_obs####
  output$pp_dens_rep_vs_obs_out <- renderPlot({
    x <- suppressMessages(pp_dens_rep_vs_obs())
    suppress_and_print(x)
  }, bg = "transparent")
  #### PLOTS: pp hists_test_statistics####
  output$pp_hists_test_statistics_mean_out <- renderPlot({
    x <- suppressMessages(pp_hists_test_statistics_mean())
    suppress_and_print(x)
  }, bg = "transparent")
  output$pp_hists_test_statistics_sd_out <- renderPlot({
    x <- suppressMessages(pp_hists_test_statistics_sd())
    suppress_and_print(x)
  }, bg = "transparent")
  output$pp_hists_test_statistics_min_out <- renderPlot({
    x <- suppressMessages(pp_hists_test_statistics_min())
    suppress_and_print(x)
  }, bg = "transparent")
  output$pp_hists_test_statistics_max_out <- renderPlot({
    x <- suppressMessages(pp_hists_test_statistics_max())
    suppress_and_print(x)
  }, bg = "transparent")
  output$pp_hist_resids_out <- renderPlot({
    x <- suppressMessages(pp_hist_resids())
    suppress_and_print(x)
  }, bg = "transparent")
  output$pp_avg_rep_vs_avg_resid_rep_out <- renderPlot({
    pp_avg_rep_vs_avg_resid_rep()
  }, bg = "transparent")
  output$pp_y_vs_avg_rep_out <- renderPlot({
    pp_y_vs_avg_rep()
  }, bg = "transparent")
  
  
  output$accept_stat_trace_out <- renderPlot({
    x <- suppressMessages(accept_stat_trace())
    suppress_and_print(x)
  })
  output$accept_stat_hist_out <- renderPlot({
    x <- suppressMessages(accept_stat_hist())
    suppress_and_print(x)
  })
  output$accept_stat_corr_lp_out <- renderPlot({
    x <- suppressMessages(accept_stat_corr_lp())
    suppress_and_print(x)
  })
  output$lp_trace_out <- renderPlot({
    x <- suppressMessages(lp_trace())
    suppress_and_print(x)
  })
  output$lp_hist_out <- renderPlot({
    x <- suppressMessages(lp_hist())
    suppress_and_print(x)
  })

  
  
} # End shinyServer

